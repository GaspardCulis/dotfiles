#!venv/bin/python

import os
import argparse


# https://stackoverflow.com/a/287944
class bcolors:
    BLUE = "\033[94m"
    GREEN = "\033[92m"
    PURPLE = "\033[95m"
    ENDC = "\033[0m"
    BOLD = "\033[1m"
    UNDERLINE = "\033[4m"


parser = argparse.ArgumentParser(
    prog="Dotfiles sync",
    description="Saves and restores my dotfiles",
)
parser.add_argument("action", choices=["save", "restore"])
parser.add_argument(
    "-s",
    "--select",
    help="Select the files and folders to sync",
    action="store_true",
)

synced_files = [
    ("editor/helix/", "~/.config/helix/"),
    ("de/i3/", "~/.config/i3/"),
    ("de/hypr/", "~/.config/hypr/"),
    ("shell/bash/.bash_profile", "~/.bash_profile"),
    ("shell/bash/.bashrc", "~/.bashrc"),
    ("shell/bash/.bash_aliases", "~/.bash_aliases"),
    ("shell/bash/.bash_env", "~/.bash_env"),
    ("shell/bash/.bash_exec", "~/.bash_exec"),
    ("shell/nu/.nu_aliases", "~/.nu_aliases"),
    ("term/rio/", "~/.config/rio/"),
    ("term/alacritty/", "~/.config/alacritty/"),
    ("bar/waybar/", "~/.config/waybar/"),
    ("bar/i3status-rust/", "~/.config/i3status-rust/"),
    ("bar/eww/", "~/.config/eww/"),
    ("home/xinitrc", "~/.xinitrc"),
    ("misc/picom/", "~/.config/picom/"),
    ("misc/runst/", "~/.config/runst/"),
    ("misc/mako/", "~/.config/mako/"),
    ("misc/swayosd/", "~/.config/swayosd/"),
    ("misc/x11-toggle-gpu/", "~/.local/share/x11-toggle-gpu/"),
    ("bin/swaylock-hyprland", "~/.local/bin/swaylock-hyprland"),
    ("bin/Hyprland", "~/.local/bin/Hyprland"),
    ("bin/jaaj", "~/.local/bin/jaaj"),
    ("bin/xtoggle-touchpad", "~/.local/bin/xtoggle-touchpad"),
    ("bin/wtoggle-touchpad", "~/.local/bin/wtoggle-touchpad"),
    ("bin/togglescreen", "~/.local/bin/togglescreen"),
    ("bin/mc-key-fix", "~/.local/bin/mc-key-fix"),
    ("bin/x11-toggle-primary-gpu", "~/.local/bin/x11-toggle-primary-gpu"),
    ("bin/uwu-launcher", "~/.local/bin/uwu-launcher"),
    # Submodules
    ("Ahurac-dotfiles/bin/ssh-fwd", "~/.local/bin/ssh-fwd"),
]


def save(fd: tuple[str, str]):
    folder = "/".join(fd[0].split("/")[0:-1])
    if not os.path.exists(folder):
        os.mkdir(folder)
    os.system(f"rsync -r {fd[1]} {fd[0]}")


def restore(fd: tuple[str, str]):
    os.system(f"rsync -r {fd[0]} {fd[1]}")


def list_files(reverse: bool = False) -> list[int]:
    len_len = len(str(len(synced_files)))
    for i, f in enumerate(synced_files):
        i = str(i)
        i = " " * (len_len - len(i)) + i

        print(
            f"{bcolors.PURPLE}{i} {bcolors.GREEN}{f[int(reverse)]} {bcolors.ENDC}-> {bcolors.GREEN}{f[int(not reverse)]}{bcolors.ENDC}"
        )
    user_action = input(
        f"{bcolors.BOLD}{bcolors.BLUE}::{bcolors.ENDC} {bcolors.BOLD}Files to sync (eg: 1 2 3, 1-3):\n{bcolors.BLUE}::{bcolors.ENDC} "
    )

    # Parse input
    out = []
    if user_action.count("-") == 0:
        out = list(map(lambda x: int(x), user_action.split()))
    elif user_action.count("-") == 1:
        out = list(range(*map(lambda x: int(x), user_action.split("-"))))
        out += [out[-1] + 1]
    else:
        raise Exception("Invalid user input")

    return out


if __name__ == "__main__":
    args = parser.parse_args()

    msg = ""
    r = list_files(args.action == "save") if args.select else range(len(synced_files))
    for ri, i in enumerate(r):
        if args.action == "save":
            save(synced_files[i])
        elif args.action == "restore":
            restore(synced_files[i])
        print(" " * len(msg), end="\r")
        index = "0" * (len(str(len(r))) - len(str(ri + 1))) + str(ri + 1)
        msg = f"[{index}/{len(r)}] Synced {synced_files[i]}"
        print(msg, end="\r")
